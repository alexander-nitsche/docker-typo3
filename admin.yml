version: '3'
services:

  install-typo3-git:
    image: typo3/php
    volumes:
      - ./typo3:/var/www/html
    environment:
      SCRIPT_VERBOSE: 0
      TYPO3_RELEASE: "10.4"
    command: >
      /bin/sh -c '
        [ "$${SCRIPT_VERBOSE}" -eq "1" ] && set -x;
        [ -d "public" ] && echo "TYPO3 exists already." && exit;
        mkdir -p public;
        git clone --single-branch --branch $${TYPO3_RELEASE} -- https://github.com/TYPO3/TYPO3.CMS.git /var/www/html/public;
        cd public;
        composer install;
        touch ./FIRST_INSTALL;
      '

  install-typo3-composer:
    image: typo3/php
    volumes:
      - ./typo3:/var/www/html
    environment:
      SCRIPT_VERBOSE: 0
      TYPO3_RELEASE: "10"
    command: >
      /bin/sh -c '
        [ "$${SCRIPT_VERBOSE}" -eq "1" ] && set -x;
        [ -d "public" ] && echo "TYPO3 exists already." && exit;
        composer create-project typo3/cms-base-distribution . ^$${TYPO3_RELEASE};
        chmod 2770 ./public;
        touch ./public/FIRST_INSTALL;
      '

  install-typo3-non-composer:
    image: typo3/php
    volumes:
      - ./typo3:/var/www/html
    environment:
      SCRIPT_VERBOSE: 0
      TYPO3_RELEASE: "10"
    command: >
      /bin/sh -c '
        [ "$${SCRIPT_VERBOSE}" -eq "1" ] && set -x;
        [ -d "public" ] && echo "TYPO3 exists already." && exit;
        wget -O -  https://get.typo3.org/$${TYPO3_RELEASE} | tar -xzf -;
        mkdir -p public;
        chmod 2770 ./public;
        ln -s typo3_src-* typo3_src;
        ln -s ../typo3_src/typo3 public/typo3;
        ln -s ../typo3_src/index.php public/index.php;
        touch ./public/FIRST_INSTALL;
      '

  purge-typo3-php:
    image: typo3/php
    volumes:
      - ./typo3:/var/www/html
    environment:
      SCRIPT_VERBOSE: 0
    command: >
      /bin/sh -c '
        [ "$${SCRIPT_VERBOSE}" -eq "1" ] && set -x;
        rm -rf ./.[^.] ./.??* ./*;
      '

  purge-typo3-mariadb:
    image: typo3/mariadb
    environment:
      SCRIPT_VERBOSE: 0
    command: >
      /bin/sh -c '
        [ "$${SCRIPT_VERBOSE}" -eq "1" ] && set -x;
        echo Waiting for database start...;
        while ! mysql -utypo3 -ptypo3 -hmariadb -e "\q"; do
          sleep 1;
        done;
        echo Database is up;
        mysql -utypo3 -ptypo3 -hmariadb -e "
          SET FOREIGN_KEY_CHECKS = 0;
          SET @tables = NULL;
          SELECT GROUP_CONCAT(\"\`\", table_schema, \"\`.\`\", table_name, \"\`\") INTO @tables
            FROM information_schema.tables
            WHERE table_schema = \"typo3\";
          SET @tables = CONCAT(\"DROP TABLE \", @tables);

          PREPARE stmt FROM @tables;
          EXECUTE stmt;
          DEALLOCATE PREPARE stmt;
          SET FOREIGN_KEY_CHECKS = 1;
        ";
      '

  purge-typo3:
    image: typo3/php
    depends_on:
      - purge-typo3-php
      - purge-typo3-mariadb
    command: >
      /bin/sh -c '
        echo "TYPO3 purged.";
      '

networks:
  admin:
